<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Database support &mdash; Spectacles  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/./custom.css" type="text/css" />
    <link rel="shortcut icon" href="_static/spectacles_round.png"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Dependencies" href="general/general.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="#" class="icon icon-home"> Spectacles
            <img src="_static/spectacles_round.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">General documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="general/general.html">Dependencies</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Webserver documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="web/web.html">User management</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="#">Spectacles</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="#" class="icon icon-home"></a> &raquo;</li>
      <li>Database support</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/index.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <img alt="_images/spectacles_text.png" src="_images/spectacles_text.png" />
<a class="reference external image-reference" href="https://GitHub.com/P-T-I/spectacles/releases/"><img alt="https://img.shields.io/github/release/P-T-I/spectacles.svg" src="https://img.shields.io/github/release/P-T-I/spectacles.svg" /></a>
<a class="reference external image-reference" href="https://www.gnu.org/licenses/gpl-3.0"><img alt="https://img.shields.io/badge/License-GPLv3-blue.svg" src="https://img.shields.io/badge/License-GPLv3-blue.svg" /></a>
<a class="reference external image-reference" href="https://GitHub.com/P-T-I/spectacles"><img alt="https://badgen.net/badge/Github/repo/green?icon=github" src="https://badgen.net/badge/Github/repo/green?icon=github" /></a>
<p>Spectacles is a docker image which can be used to act as an authorization server for docker v2 registries. It provides
a web interface to allow you full control over the available repositories in your private registry. Spectacles has a
fine grained user management system and allows these user READ, WRITE or FULL access to repositories via the use of
fully configurable namespaces.</p>
<section id="database-support">
<h1>Database support<a class="headerlink" href="#database-support" title="Permalink to this headline"></a></h1>
<p>Spectacles can be used with different sql databases and has been tested with sqllite and mysql as database backends.
In order to fully make use of the functionalities of spectacles; an external mysql instance is highly advised.</p>
<p>This is because a local sqllite database will (for the moment) limit spectacles ability to fetch updates from the
registry via a (second spectacles instance) background process and fully persist spectacles state.
See <a class="reference internal" href="#configuring-spectacles">Configuring spectacles</a> for more details.</p>
</section>
<section id="configuring-spectacles">
<h1>Configuring spectacles<a class="headerlink" href="#configuring-spectacles" title="Permalink to this headline"></a></h1>
<p>As mentioned in the previous paragraph spectacles needs 2 containers in order to be fully functional; 1 for the webserver
and 1 for a background process. The webserver container is the default with which the image is build and handles all
gui related actions and inputs. The background container is responsible for periodically contacting the registry and
updating the repository tag entries in the database. In order to activate the background process the command for the
spectacles image need to be overwritten with <code class="docutils literal notranslate"><span class="pre">[&quot;runbackground&quot;]</span></code>. As shown in the docker-compose_EXAMPLE.yml
file.</p>
<section id="data-persistence">
<h2>Data Persistence<a class="headerlink" href="#data-persistence" title="Permalink to this headline"></a></h2>
<p>All data that should be able to survive a container rebuild/restart (like avatars, logs, registry certs, and sqllite
database) is saved by spectacles in the <cite>/app/data</cite> folder inside the container. So a volume should be mounted from
the host to the <cite>/app/data</cite> folder. As shown in the docker-compose_EXAMPLE.yml file.</p>
</section>
<section id="setup-tls-for-spectacles-webserver">
<h2>Setup TLS for spectacles webserver<a class="headerlink" href="#setup-tls-for-spectacles-webserver" title="Permalink to this headline"></a></h2>
<p>By default spectacles will run a HTTP webserver; if you would like to use a HTTPS webserver then mount an additional
volume containing the key en certificate (in pem format) into the container and set the environment variables
<code class="docutils literal notranslate"><span class="pre">SPECTACLES_WEB_TLS_KEY_PATH</span></code> and <code class="docutils literal notranslate"><span class="pre">SPECTACLES_WEB_TLS_CERT_PATH</span></code> accordingly.</p>
</section>
<section id="environment-variables">
<h2>Environment variables<a class="headerlink" href="#environment-variables" title="Permalink to this headline"></a></h2>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">DB_HOST</span></code> (default: <em>mysql</em>): IP-address or FQDN of the MYSQL database;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DB_BACKEND</span></code> (default: <em>mysql</em>): Select which backend you would like to use for spectacles. Choices are ‘mysql’ or
‘other’;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SQLALCHEMY_DATABASE_URI</span></code> (default: <em>sqlite:////app/data/db/spectacles.db</em>): The database URI that should be used
for the connection. Examples:</p>
<ul>
<li><p>sqlite:////tmp/test.db</p></li>
<li><p>mysql://username:password&#64;server/db</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">AVATARS_SAVE_PATH</span></code> (default: <em>/app/data/avatars/</em>): Path where to store the avatars created for spectacles users;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SPECTACLES_PRIV_KEY_PATH</span></code> (default: <em>/app/data/certs/domain.key</em>): Path to where the private key used by the
registry to validate the created tokens from spectacles. This should be the same key that is created in the paragraph
<a class="reference internal" href="#configuring-registry">Configuring registry</a> and set to the environment variable <code class="docutils literal notranslate"><span class="pre">REGISTRY_HTTP_TLS_KEY</span></code> of the docker registry image;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SPECTACLES_ISSUER_NAME</span></code> (default: <em>Auth service</em>): Name you wish to give to the spectacles instance. Should be set
to the same value as the environment variable <code class="docutils literal notranslate"><span class="pre">REGISTRY_AUTH_TOKEN_ISSUER</span></code> of the docker registry image;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SPECTACLES_BACKGROUND_UPDATE</span></code> (default: <em>30</em>): Specify the interval for the background process in seconds. 30 in
this example makes sure that the background process runs every 30 seconds;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SPECTACLES_WEB_TLS_KEY_PATH</span></code> (default: <em>/app/certs/key.pem</em>): Path to the TLS key for the HTTPS webserver;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SPECTACLES_WEB_TLS_CERT_PATH</span></code> (default: <em>/app/certs/cert.pem</em>): Path to the TLS certificate for the HTTPS webserver;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">OPENID_LOGIN</span></code> (default: <em>False</em>): Whether to use an openid provider for logging into spectacles;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SQL_DEBUG_LOGGING</span></code> (default: <em>False</em>): If enabled all queries to the database are logged for debug purposes;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LOG_FILE_PATH</span></code> (default: <em>/app/data/log/</em>): Directory where to store the logging;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LOG_FILE_NAME</span></code> (default: <em>spectacles.log</em>): Filename of the logging;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SYSLOG_ENABLE</span></code> (default: <em>False</em>): Whether to enable logging to a syslog server;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SYSLOG_SERVER</span></code> (default: <em>172.16.1.1</em>): IP address or FQDN of the syslog server;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SYSLOG_PORT</span></code> (default: <em>5140</em>): UDP port of the syslog server;</p></li>
</ul>
</section>
</section>
<section id="configuring-registry">
<h1>Configuring registry<a class="headerlink" href="#configuring-registry" title="Permalink to this headline"></a></h1>
<p>The registry that can be used for spectacles is a normal <a class="reference external" href="https://hub.docker.com/_/registry">docker registry</a> and
further details and settings about that image is listed there.</p>
<dl class="simple">
<dt>However for simplicity sake here is an example of the environment settings that should be set on the image:</dt><dd><ul class="simple">
<li><p>REGISTRY_STORAGE_DELETE_ENABLED=true</p></li>
<li><p>REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY=/mnt/registry/data</p></li>
<li><p>REGISTRY_AUTH=token</p></li>
<li><p>REGISTRY_AUTH_TOKEN_REALM=https://localhost:5050/token_auth</p></li>
<li><p>REGISTRY_AUTH_TOKEN_SERVICE=”Docker registry”</p></li>
<li><p>REGISTRY_AUTH_TOKEN_ISSUER=”Auth service”</p></li>
<li><p>REGISTRY_AUTH_TOKEN_ROOTCERTBUNDLE=/mnt/local/certs/domain.crt</p></li>
<li><p>REGISTRY_HTTP_TLS_CERTIFICATE=/mnt/local/certs/domain.crt</p></li>
<li><p>REGISTRY_HTTP_TLS_KEY=/mnt/local/certs/domain.key</p></li>
</ul>
</dd>
</dl>
<p>Couple of pointers:</p>
<ul>
<li><p>the <code class="docutils literal notranslate"><span class="pre">REGISTRY_STORAGE_DELETE_ENABLED</span></code> variable controls whether or not the registry let’s you ‘delete’ a
repository / tag.
Please keep in mind that, although the repository / tag seems deleted, it’s not really gone until you run the registry’s
garbage collector. More details in the <a class="reference external" href="https://docs.docker.com/registry/">documentation</a>;</p></li>
<li><p>the <code class="docutils literal notranslate"><span class="pre">REGISTRY_AUTH_TOKEN_REALM</span></code> should be set to the IP address / FQDN of the spectacles webserver and should point
to the token_auth endpoint;</p></li>
<li><p>the <code class="docutils literal notranslate"><span class="pre">REGISTRY_AUTH_TOKEN_ISSUER</span></code> should be set to the same value as <code class="docutils literal notranslate"><span class="pre">SPECTACLES_ISSUER_NAME</span></code> from the previous
paragraph;</p></li>
<li><p>the <code class="docutils literal notranslate"><span class="pre">REGISTRY_HTTP_TLS_KEY</span></code> should be set to the path to the registry’s private key and should be set to the same
key as <code class="docutils literal notranslate"><span class="pre">SPECTACLES_PRIV_KEY_PATH</span></code>. The private key can be created via the command:</p>
<blockquote>
<div><p>openssl req -newkey rsa:4096 -nodes -keyout domain.key -out domain.csr -subj ‘/C=XX/ST=XX/L=XXXX/O=Docker
Registry/CN=example.docker.reg’</p>
</div></blockquote>
</li>
<li><p>the <code class="docutils literal notranslate"><span class="pre">REGISTRY_AUTH_TOKEN_ROOTCERTBUNDLE</span></code> and the <code class="docutils literal notranslate"><span class="pre">REGISTRY_HTTP_TLS_CERTIFICATE</span></code> should be set to the path of the
registry’s signed certificate. The certificate can be created / signed via the command:</p>
<blockquote>
<div><p>openssl x509 -signkey domain.key -in domain.csr -req -days 3650 -out domain.crt</p>
</div></blockquote>
</li>
<li><p>if you would like to persist the registry’s data you should mount a volume to the /mnt/registry/data;</p></li>
<li><p>the certificate and key created earlier should be mounted into the /mnt/local/certs.</p></li>
</ul>
</section>
<section id="quick-start">
<h1>Quick start<a class="headerlink" href="#quick-start" title="Permalink to this headline"></a></h1>
<p>The easiest way to quickly setup a full suite is to use the provided docker-compose_EXAMPLE.yml. Once that file is
tweaked to your specifications all steps below assume that you’ve renamed the docker-compose_EXAMPLE.yml to
docker-compose.yml; if that’s not the case you should specify the file with a -f flag appended to the docker-compose
command.</p>
<p>These steps can be read in the full <a class="reference external" href="https://p-t-i.github.io/spectacles/">documentation</a> (NOT COMPLETED YET);</p>
<p>Start all containers:</p>
<blockquote>
<div><p>docker-compose up</p>
</div></blockquote>
<p>Once the containers are up and running; navigate to http(s)://localhost:5050 and register your first user. (The first
registered user will automatically be made an administrative user.)</p>
<p>Once logged-in navigate to the ‘Registries’ page and add your first registry.</p>
<p>Once successful add a namespace to the registry you’ve just configured by navigating to the namespaces page and create
the namespace ‘test’.</p>
<p>Now your set to login to your registry and push your first repository.</p>
<p>From the command line (assuming your registry runs on the default port of 5000):</p>
<blockquote>
<div><p>docker login localhost:5000</p>
</div></blockquote>
<p>It will request your username and password (from the admin user you’ve just created within spectacles) and will report
back when the login is successful.</p>
<p>Now pull a image from the public docker hub and tag it for our private repository:</p>
<blockquote>
<div><p>docker pull hello-world</p>
<p>docker tag hello-world:latest localhost:5000/test/hello-world:latest</p>
</div></blockquote>
<p>Push the image to the private repo:</p>
<blockquote>
<div><p>docker push localhost:5000/test/hello-world:latest</p>
</div></blockquote>
<p>Once the sheduled background process has completed it will show up within spectacles.</p>
</section>
<section id="general">
<h1>General<a class="headerlink" href="#general" title="Permalink to this headline"></a></h1>
<div class="toctree-wrapper compound">
<p class="caption" role="heading"><span class="caption-text">General documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="general/general.html">Dependencies</a></li>
</ul>
</div>
<div class="toctree-wrapper compound">
<p class="caption" role="heading"><span class="caption-text">Webserver documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="web/web.html">User management</a></li>
</ul>
</div>
<section id="indices-and-tables">
<h2>Indices and tables<a class="headerlink" href="#indices-and-tables" title="Permalink to this headline"></a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="genindex.html"><span class="std std-ref">Index</span></a></p></li>
<li><p><a class="reference internal" href="py-modindex.html"><span class="std std-ref">Module Index</span></a></p></li>
<li><p><a class="reference internal" href="search.html"><span class="std std-ref">Search Page</span></a></p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="general/general.html" class="btn btn-neutral float-right" title="Dependencies" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, P-T-I.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>